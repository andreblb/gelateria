<%= form_with(model: @pedido, id: "pedido-form") do |f| %>
  <h2 style="color: var(--roxo-acai);">üìù Novo Pedido de A√ßa√≠</h2>
  
  <div style="margin-bottom: 20px;">
    <%= f.label :customer_id, "Cliente" %>
    <%= f.collection_select :customer_id, Customer.all, :id, :name, { prompt: "Selecione o cliente" }, { class: "form-control" } %>
  </div>

  <div style="margin-bottom: 20px;">
    <%= f.label :delivery_address, "Endere√ßo de Entrega" %>
    <%= f.text_field :delivery_address, class: "form-control", placeholder: "Rua, n√∫mero e bairro" %>
  </div>

  <div style="background: #f9f0ff; padding: 20px; border-radius: 10px; border-left: 5px solid var(--roxo-acai); margin-bottom: 20px;">
    <h3>üçì Escolha os Sabores e Quantidades</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <% Product.all.each_with_index do |product, index| %>
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; background: white; padding: 10px; border-radius: 5px;">
          <span><%= product.name %> - <strong><%= number_to_currency(product.price) %></strong></span>
          
          <div style="display: flex; align-items: center; gap: 5px;">
            <%# Campo de Quantidade que o Ruby vai ler %>
            <%= number_field_tag "pedido[pedido_items_attributes][#{index}][quantity]", 
                @pedido.pedido_items.find { |i| i.product_id == product.id }&.quantity || 0, 
                min: 0, style: "width: 50px; border: 1px solid #ccc; border-radius: 4px; text-align: center;" %>
            
            <%= hidden_field_tag "pedido[pedido_items_attributes][#{index}][product_id]", product.id %>
          </div>
        </div>
      <% end %>
    </div>
    
    <%# Bot√£o Calcular mantendo sua identidade visual %>
    <%= f.submit "Calcular Total", formmethod: :get, formaction: new_pedido_path, 
        style: "margin-top: 15px; background: var(--roxo-acai); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;" %>
  </div>

  <div style="display: flex; gap: 20px; align-items: center;">
    <div style="flex: 1;">
      <%= f.label :discount_percent, "Desconto (%)" %>
      <%= f.number_field :discount_percent, class: "form-control", value: @pedido.discount_percent || 0 %>
    </div>
    <div style="flex: 1; text-align: right;">
      <span style="font-size: 1.1rem; color: #666;">Total Final:</span><br>
      
      <%= turbo_frame_tag "total_display" do %>
        <strong style="font-size: 2.5rem; color: #2e7d32;">
          <%= number_to_currency(@pedido.total_price || 0) %>
        </strong>
        <%= f.hidden_field :total_price, value: @pedido.total_price %>
      <% end %>
    </div>
  </div>

  <div style="margin-top: 30px;">
    <%= f.submit "Salvar e Finalizar Pedido", class: "btn-primary" %>
  </div>
<% end %>